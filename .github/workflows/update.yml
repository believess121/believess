name: Update Repository Index

on:
  push:
    paths:
      - 'debs/**'
  workflow_dispatch:  # 允许手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev bzip2 gzip
    
    - name: Generate Packages files
      run: |
        echo "正在生成索引文件..."
        cd debs
        dpkg-scanpackages . /dev/null > ../Packages
        cd ..
        
        echo "创建压缩版本..."
        bzip2 -fk9 Packages > Packages.bz2
        gzip -fk9 Packages > Packages.gz
        
        echo "添加时间戳..."
        echo "Last updated: $(date)" > Packages.stamp
    
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        git add Packages Packages.bz2 Packages.gz Packages.stamp
        git diff --quiet && git diff --staged --quiet || git commit -m "自动更新索引"
        git push
