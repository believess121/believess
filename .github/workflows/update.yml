name: ğŸš€ Update Believess Repository (Keep History)

on:
  push:
    paths:
      - 'debs/**'
  workflow_dispatch:

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Install tools
      run: sudo apt-get update && sudo apt-get install -y dpkg-dev bzip2 gzip
    
    - name: ğŸ“¦ Generate Packages with all versions
      run: |
        echo "=== ç”ŸæˆåŒ…å«æ‰€æœ‰ç‰ˆæœ¬çš„ç´¢å¼• ==="
        
        # è¿›å…¥debsç›®å½•
        cd debs
        
        # ç”ŸæˆåŒ…å«æ‰€æœ‰debæ–‡ä»¶çš„Packages
        # è¿™è¡Œå‘½ä»¤ä¼šè®©æ‰€æœ‰ç‰ˆæœ¬çš„debéƒ½å‡ºç°åœ¨Packagesæ–‡ä»¶ä¸­
        dpkg-scanpackages . /dev/null > ../Packages
        
        # ç»Ÿè®¡ä¿¡æ¯
        echo "ğŸ“Š ç‰ˆæœ¬ç»Ÿè®¡ï¼š"
        find . -name "*.deb" | sed 's|./||' | sort
        echo ""
        
        echo "ğŸ“‹ åŒ…åç»Ÿè®¡ï¼š"
        find . -name "*.deb" | sed 's|.*/||' | sed 's|_.*||' | sort | uniq -c
        
        cd ..
    
    - name: ğŸ—œï¸ Create compressed files
      run: |
        bzip2 -kf Packages
        gzip -kf Packages
        
        echo "â° æ—¶é—´æˆ³ï¼š$(date)" > Packages.stamp
        echo "åŒ…å«çš„å†å²ç‰ˆæœ¬ï¼š" >> Packages.stamp
        grep "Version:" Packages | sort -u | head -20 >> Packages.stamp
    
    - name: ğŸ’¾ Commit
      run: |
        git config --local user.email "bot@believess.com"
        git config --local user.name "believess-bot"
        git add Packages Packages.* Packages.stamp
        git diff --cached --quiet || git commit -m "ğŸ¤– æ›´æ–°ç´¢å¼• - åŒ…å«$(date +%Y%m%d)çš„æ‰€æœ‰ç‰ˆæœ¬"
        git push
