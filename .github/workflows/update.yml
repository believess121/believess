name: Update Believess Repo

on:
  push:
    paths:
      - 'debs/**'
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è¿è¡Œ

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€æŸ¥ä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: å®‰è£…å¿…è¦å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-scanpackages bzip2 gzip coreutils
    
    - name: ç”Ÿæˆç´¢å¼•æ–‡ä»¶
      run: |
        echo "ğŸ”„ æ­£åœ¨ä¸º believess æºç”Ÿæˆç´¢å¼•..."
        
        # ç”Ÿæˆ Packages æ–‡ä»¶
        cd debs
        if [ -n "$(find . -name '*.deb' -print -quit)" ]; then
          dpkg-scanpackages . /dev/null > ../Packages
          echo "âœ… Packages æ–‡ä»¶å·²ç”Ÿæˆ"
        else
          echo "# Empty repository" > ../Packages
          echo "âš ï¸  æ²¡æœ‰æ‰¾åˆ° .deb æ–‡ä»¶ï¼Œåˆ›å»ºç©ºç´¢å¼•"
        fi
        cd ..
        
        # åˆ›å»ºå‹ç¼©ç‰ˆæœ¬
        echo "ğŸ“¦ åˆ›å»ºå‹ç¼©æ–‡ä»¶..."
        bzip2 -c9 Packages > Packages.bz2 2>/dev/null || touch Packages.bz2
        gzip -c9 Packages > Packages.gz 2>/dev/null || touch Packages.gz
        
        # æ·»åŠ æ—¶é—´æˆ³
        echo "â° æ·»åŠ æ›´æ–°æ—¶é—´..."
        echo "Believess Repository - Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > Packages.stamp
        echo "Source: https://github.com/${{ github.repository }}" >> Packages.stamp
    
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "believess-bot@users.noreply.github.com"
        git config --local user.name "believess-bot"
        git add Packages Packages.bz2 Packages.gz Packages.stamp
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --staged --quiet; then
          echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          git commit -m "ğŸ¤– Auto-update: Regenerated index at $(date -u '+%H:%M:%S UTC')"
          git push
          echo "âœ… ç´¢å¼•å·²æ›´æ–°å¹¶æ¨é€"
        fi
