name: ğŸ”„ Update Repository with All Versions

on:
  # æ”¹ä¸ºç‰¹å®šæ—¶é—´è§¦å‘ï¼Œé¿å…ä¸pushå†²çª
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºæ‰€æœ‰ç´¢å¼•'
        required: false
        default: 'false'

jobs:
  rebuild-index:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“Š Check deb files
      run: |
        echo "=== æ£€æŸ¥debsæ–‡ä»¶å¤¹ ==="
        if [ ! -d "debs" ]; then
          echo "âŒ debsæ–‡ä»¶å¤¹ä¸å­˜åœ¨"
          mkdir -p debs
        fi
        
        echo "ğŸ“ æ–‡ä»¶å¤¹å†…å®¹ï¼š"
        ls -la debs/ || echo "ç©ºæ–‡ä»¶å¤¹"
        
        echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰.debæ–‡ä»¶ï¼š"
        find debs -name "*.deb" -type f | while read deb; do
          echo "  - $deb"
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -lh "$deb"
        done
        
        COUNT=$(find debs -name "*.deb" -type f | wc -l)
        echo "âœ… æ€»å…±æ‰¾åˆ° $COUNT ä¸ª.debæ–‡ä»¶"
        
        if [ $COUNT -eq 0 ]; then
          echo "âš ï¸  è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ°.debæ–‡ä»¶"
        fi
    
    - name: ğŸ”§ Generate Packages with ALL versions
      run: |
        echo "=== ç”ŸæˆåŒ…å«æ‰€æœ‰ç‰ˆæœ¬çš„Packagesæ–‡ä»¶ ==="
        
        # æ¸…ç†æ—§æ–‡ä»¶
        rm -f Packages Packages.bz2 Packages.gz
        
        # å¦‚æœæ²¡æœ‰debæ–‡ä»¶ï¼Œåˆ›å»ºç©ºçš„Packages
        if [ ! -d "debs" ] || [ -z "$(find debs -name '*.deb' -print -quit)" ]; then
          echo "# Empty repository - waiting for packages" > Packages
          echo "æ²¡æœ‰æ‰¾åˆ°.debæ–‡ä»¶ï¼Œåˆ›å»ºç©ºç´¢å¼•"
        else
          echo "# Believess Repository" > Packages
          echo "# Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> Packages
          echo "# This file includes ALL versions of all packages" >> Packages
          echo "" >> Packages
          
          # ä½¿ç”¨dpkg-scanpackageså¤„ç†æ‰€æœ‰æ–‡ä»¶
          cd debs
          
          # ä¸ºæ¯ä¸ªdebæ–‡ä»¶å•ç‹¬å¤„ç†ï¼Œç¡®ä¿æ‰€æœ‰ç‰ˆæœ¬éƒ½è¢«åŒ…å«
          for DEB in *.deb; do
            if [ -f "$DEB" ]; then
              echo "ğŸ”¨ å¤„ç†: $DEB"
              
              # æå–åŒ…åç”¨äºä¸´æ—¶å¤„ç†
              PKG_NAME=$(echo "$DEB" | cut -d_ -f1)
              
              # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥å¤„ç†è¿™ä¸ªdeb
              TEMP_DIR="/tmp/deb_$PKG_NAME"
              mkdir -p "$TEMP_DIR"
              cp "$DEB" "$TEMP_DIR/"
              
              # ç”Ÿæˆè¿™ä¸ªdebçš„æ¡ç›®
              dpkg-scanpackages "$TEMP_DIR" /dev/null 2>/dev/null | \
                sed "s|Filename: $TEMP_DIR/|Filename: ./debs/|" >> ../Packages
              
              # æ·»åŠ ç©ºè¡Œåˆ†éš”
              echo "" >> ../Packages
              
              rm -rf "$TEMP_DIR"
            fi
          done
          
          cd ..
          
          # æ‰‹åŠ¨éªŒè¯
          echo "ğŸ“Š ç”Ÿæˆçš„æ¡ç›®ç»Ÿè®¡ï¼š"
          echo "æ€»æ¡ç›®æ•°: $(grep -c '^Package:' Packages)"
          echo "å”¯ä¸€åŒ…å: $(grep '^Package:' Packages | sort -u | wc -l)"
          echo "æ‰€æœ‰ç‰ˆæœ¬:"
          grep '^Package:' Packages | sort | uniq -c
        fi
    
    - name: ğŸ—œï¸ Create compressed versions
      run: |
        echo "=== åˆ›å»ºå‹ç¼©æ–‡ä»¶ ==="
        
        if [ -f "Packages" ]; then
          # éªŒè¯æ–‡ä»¶å†…å®¹
          echo "ğŸ“„ Packagesæ–‡ä»¶å‰100ä¸ªå­—ç¬¦ï¼š"
          head -c 100 Packages
          echo ""
          
          echo "ğŸ“¦ åˆ›å»ºå‹ç¼©ç‰ˆæœ¬..."
          bzip2 -9fk Packages
          gzip -9fk Packages
          
          echo "ğŸ“Š æ–‡ä»¶å¤§å°ï¼š"
          ls -lh Packages*
          
          # åˆ›å»ºç‰ˆæœ¬æ¸…å•
          echo "# Version Manifest" > VERSIONS.txt
          echo "Repository: believess" >> VERSIONS.txt
          echo "Updated: $(date)" >> VERSIONS.txt
          echo "" >> VERSIONS.txt
          echo "Available Packages:" >> VERSIONS.txt
          awk '/^Package:/ {pkg=$2} /^Version:/ {ver=$2} /^$/ {if(pkg && ver) print pkg " " ver; pkg=""; ver=""}' Packages | \
            sort >> VERSIONS.txt
        else
          echo "âŒ Packagesæ–‡ä»¶ä¸å­˜åœ¨"
          touch Packages.bz2 Packages.gz
        fi
    
    - name: ğŸ“ Create debug info
      run: |
        echo "=== è°ƒè¯•ä¿¡æ¯ ===" > DEBUG.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> DEBUG.md
        echo "" >> DEBUG.md
        echo "**debsæ–‡ä»¶å¤¹å†…å®¹ï¼š**" >> DEBUG.md
        echo '```' >> DEBUG.md
        ls -la debs/ >> DEBUG.md 2>/dev/null || echo "ç©ºæ–‡ä»¶å¤¹" >> DEBUG.md
        echo '```' >> DEBUG.md
        echo "" >> DEBUG.md
        
        echo "**Packagesæ–‡ä»¶ç»Ÿè®¡ï¼š**" >> DEBUG.md
        if [ -f "Packages" ]; then
          echo "- æ€»è¡Œæ•°: $(wc -l < Packages)" >> DEBUG.md
          echo "- åŒ…æ¡ç›®: $(grep -c '^Package:' Packages)" >> DEBUG.md
          echo "- ç‰ˆæœ¬æ•°: $(grep -c '^Version:' Packages)" >> DEBUG.md
          echo "" >> DEBUG.md
          echo "**æ‰€æœ‰åŒ…å’Œç‰ˆæœ¬ï¼š**" >> DEBUG.md
          echo '```' >> DEBUG.md
          awk '/^Package:/ {pkg=$2} /^Version:/ {ver=$2} /^$/ {if(pkg && ver) printf "%-30s %s\n", pkg, ver; pkg=""; ver=""}' Packages | \
            sort >> DEBUG.md
          echo '```' >> DEBUG.md
        else
          echo "Packagesæ–‡ä»¶æœªç”Ÿæˆ" >> DEBUG.md
        fi
    
    - name: ğŸ’¾ Commit and push changes
      run: |
        echo "=== æäº¤æ›´æ”¹ ==="
        
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
        git add Packages Packages.bz2 Packages.gz VERSIONS.txt DEBUG.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --cached --quiet; then
          echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          git commit -m "ğŸ”„ æ›´æ–°ç´¢å¼• - åŒ…å«æ‰€æœ‰ç‰ˆæœ¬ [$(date +%Y%m%d-%H%M%S)]"
          git push
          echo "âœ… å·²æäº¤æ›´æ”¹"
        fi
        
        echo ""
        echo "ğŸ¯ ä¸‹ä¸€æ­¥ï¼š"
        echo "1. è®¿é—® https://raw.githubusercontent.com/${{ github.repository }}/main/Packages"
        echo "2. ç¡®è®¤æ‰€æœ‰ç‰ˆæœ¬éƒ½åœ¨æ–‡ä»¶ä¸­"
        echo "3. åœ¨Sileoä¸­åˆ·æ–°æº"
