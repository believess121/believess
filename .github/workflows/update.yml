name: ğŸš€ Update Repository (Keep All Versions)

on:
  push:
    paths:
      - 'debs/**'
  workflow_dispatch:

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ”§ Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-scanpackages
        sudo apt-get install -y bzip2 gzip
    
    - name: ğŸ“¦ Generate Packages with ALL versions
      run: |
        echo "=== å¼€å§‹ç”ŸæˆåŒ…å«æ‰€æœ‰ç‰ˆæœ¬çš„ç´¢å¼• ==="
        
        # æ£€æŸ¥debsæ–‡ä»¶å¤¹å†…å®¹
        echo "ğŸ” debsæ–‡ä»¶å¤¹å†…å®¹ï¼š"
        ls -la debs/ || echo "debsæ–‡ä»¶å¤¹ä¸å­˜åœ¨"
        
        # åˆ—å‡ºæ‰€æœ‰debæ–‡ä»¶
        echo "ğŸ“‹ æ‰€æœ‰debæ–‡ä»¶ï¼š"
        find debs -name "*.deb" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°debæ–‡ä»¶"
        
        # å…³é”®ï¼šç”ŸæˆåŒ…å«æ‰€æœ‰ç‰ˆæœ¬çš„Packagesæ–‡ä»¶
        if [ -d "debs" ]; then
          echo "ğŸ”„ ç”ŸæˆPackagesæ–‡ä»¶..."
          cd debs
          
          # ä½¿ç”¨dpkg-scanpackagesç”ŸæˆåŒ…å«æ‰€æœ‰æ–‡ä»¶çš„ç´¢å¼•
          # --multiversion å‚æ•°è®©æ‰€æœ‰ç‰ˆæœ¬éƒ½å‡ºç°
          dpkg-scanpackages . /dev/null 2>/dev/null | \
            awk 'BEGIN{last=""} /^Package:/{pkg=$2} /^Version:/{ver=$2} /^$/ {if(pkg && ver) print pkg "=" ver; pkg=""; ver=""}' | \
            sort -u > ../package_versions.txt
          
          # ç”Ÿæˆå®Œæ•´çš„Packagesæ–‡ä»¶
          dpkg-scanpackages . /dev/null > ../Packages
          
          cd ..
          
          echo "ğŸ“Š åŒ…å«çš„åŒ…ç‰ˆæœ¬ï¼š"
          cat package_versions.txt || echo "æ— æ³•è¯»å–ç‰ˆæœ¬ä¿¡æ¯"
          
          echo "âœ… Packagesæ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          echo "å‰å‡ è¡Œå†…å®¹ï¼š"
          head -20 Packages
        else
          echo "âŒ debsæ–‡ä»¶å¤¹ä¸å­˜åœ¨"
          echo "# Empty repository" > Packages
        fi
    
    - name: ğŸ—œï¸ Create compressed versions
      run: |
        echo "=== åˆ›å»ºå‹ç¼©æ–‡ä»¶ ==="
        
        if [ -f "Packages" ]; then
          # ç»Ÿè®¡ä¿¡æ¯
          PACKAGE_COUNT=$(grep -c "^Package:" Packages || echo "0")
          VERSION_COUNT=$(grep -c "^Version:" Packages || echo "0")
          
          echo "ğŸ“Š ç»Ÿè®¡ï¼š"
          echo "  åŒ…æ¡ç›®æ•°: $PACKAGE_COUNT"
          echo "  ç‰ˆæœ¬æ•°: $VERSION_COUNT"
          
          # åˆ›å»ºå‹ç¼©æ–‡ä»¶
          bzip2 -kf Packages
          gzip -kf Packages
          
          # åˆ›å»ºç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶
          echo "# Believess Repository - Version History" > VERSIONS.txt
          echo "# Generated: $(date)" >> VERSIONS.txt
          echo "" >> VERSIONS.txt
          
          # æå–æ‰€æœ‰ç‰ˆæœ¬ä¿¡æ¯
          awk '
            /^Package:/ {pkg=$2}
            /^Version:/ {ver=$2}
            /^Filename:/ {file=$2}
            /^$/ {
              if (pkg && ver && file) {
                printf "%s %s (%s)\n", pkg, ver, file
              }
              pkg=""; ver=""; file=""
            }
          ' Packages | sort >> VERSIONS.txt
          
        else
          echo "âŒ Packagesæ–‡ä»¶ä¸å­˜åœ¨"
          touch Packages.bz2 Packages.gz VERSIONS.txt
        fi
    
    - name: ğŸ’¾ Commit changes
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
        git add Packages Packages.bz2 Packages.gz VERSIONS.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if ! git diff --cached --quiet; then
          git commit -m "ğŸ”„ æ›´æ–°ç´¢å¼• - åŒ…å«æ‰€æœ‰å†å²ç‰ˆæœ¬ $(date +%Y%m%d-%H%M%S)"
          git push
          echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
        else
          echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        fi
