name: ğŸš€ Update Believess Repository

on:
  # å½“ debs æ–‡ä»¶å¤¹æœ‰å˜åŒ–æ—¶è§¦å‘
  push:
    paths:
      - 'debs/**'
    branches: [ "main" ]
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¯å¤©å‡Œæ™¨è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # ç¬¬ä¸€æ­¥ï¼šè·å–ä»£ç 
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²
    
    # ç¬¬äºŒæ­¥ï¼šè®¾ç½®ç¯å¢ƒ
    - name: âš™ï¸ Setup environment
      run: |
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "æ–‡ä»¶å¤¹å†…å®¹:"
        ls -la
        echo "debsæ–‡ä»¶å¤¹å†…å®¹:"
        ls -la debs/ 2>/dev/null || echo "debsæ–‡ä»¶å¤¹ä¸å­˜åœ¨"
    
    # ç¬¬ä¸‰æ­¥ï¼šå®‰è£…å·¥å…·
    - name: ğŸ”§ Install dpkg tools
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev
        sudo apt-get install -y bzip2 gzip
        
        # éªŒè¯å®‰è£…
        which dpkg-scanpackages || echo "dpkg-scanpackages æœªæ‰¾åˆ°ï¼Œå°†ä½¿ç”¨æ›¿ä»£æ–¹æ³•"
        dpkg --version
    
    # ç¬¬å››æ­¥ï¼šç”Ÿæˆç´¢å¼•æ–‡ä»¶ï¼ˆå…³é”®æ­¥éª¤ï¼‰
    - name: ğŸ“¦ Generate Packages
      run: |
        echo "=== å¼€å§‹ç”Ÿæˆç´¢å¼• ==="
        
        # ç¡®ä¿ debs æ–‡ä»¶å¤¹å­˜åœ¨
        if [ ! -d "debs" ]; then
          echo "âš ï¸ debsæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ–‡ä»¶å¤¹"
          mkdir -p debs
        fi
        
        # è¿›å…¥ debs æ–‡ä»¶å¤¹
        cd debs
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ deb æ–‡ä»¶
        DEB_COUNT=$(find . -name "*.deb" -type f | wc -l)
        echo "æ‰¾åˆ° $DEB_COUNT ä¸ª .deb æ–‡ä»¶"
        
        if [ $DEB_COUNT -eq 0 ]; then
          echo "â„¹ï¸ æ²¡æœ‰debæ–‡ä»¶ï¼Œåˆ›å»ºç©ºçš„Packagesæ–‡ä»¶"
          echo "# Empty repository - Believess" > ../Packages
          echo "ç­‰å¾…æ·»åŠ è½¯ä»¶åŒ…..." >> ../Packages
        else
          echo "ğŸ”„ æ­£åœ¨ç”Ÿæˆ Packages æ–‡ä»¶..."
          # åˆ—å‡ºæ‰€æœ‰debæ–‡ä»¶
          find . -name "*.deb" -type f | while read deb; do
            echo "å¤„ç†: $deb"
          done
          
          # ç”Ÿæˆ Packages æ–‡ä»¶
          dpkg-scanpackages . /dev/null > ../Packages 2>/dev/null || {
            echo "âŒ dpkg-scanpackages å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
            
            # å¤‡ç”¨æ–¹æ³•ï¼šæ‰‹åŠ¨åˆ›å»ºç®€å•çš„ Packages æ–‡ä»¶
            echo "# Believess Repository" > ../Packages
            echo "# Generated on: $(date)" >> ../Packages
            echo "" >> ../Packages
            
            find . -name "*.deb" -type f | while read debfile; do
              echo "Package: $(basename "$debfile" | cut -d'_' -f1)" >> ../Packages
              echo "Filename: ./debs/$(basename "$debfile")" >> ../Packages
              echo "Size: $(stat -c%s "$debfile")" >> ../Packages
              echo "MD5sum: $(md5sum "$debfile" | cut -d' ' -f1)" >> ../Packages
              echo "SHA256: $(sha256sum "$debfile" | cut -d' ' -f1)" >> ../Packages
              echo "" >> ../Packages
            done
          }
        fi
        
        cd ..
        
        echo "âœ… Packages æ–‡ä»¶å†…å®¹é¢„è§ˆï¼ˆå‰10è¡Œï¼‰ï¼š"
        head -10 Packages
        
    # ç¬¬äº”æ­¥ï¼šåˆ›å»ºå‹ç¼©ç‰ˆæœ¬
    - name: ğŸ—œï¸ Create compressed versions
      run: |
        echo "=== åˆ›å»ºå‹ç¼©æ–‡ä»¶ ==="
        
        # åˆ›å»º Packages.bz2
        if [ -f "Packages" ]; then
          echo "ğŸ“¦ åˆ›å»º Packages.bz2..."
          bzip2 -kf Packages
          
          echo "ğŸ“¦ åˆ›å»º Packages.gz..."
          gzip -kf Packages
          
          echo "â° åˆ›å»ºæ—¶é—´æˆ³æ–‡ä»¶..."
          echo "# Believess Repository - https://github.com/${{ github.repository }}" > Packages.stamp
          echo "# Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> Packages.stamp
          echo "" >> Packages.stamp
          echo "å¦‚æœçœ‹ä¸åˆ°è½¯ä»¶ï¼Œè¯·ç­‰å¾…å‡ åˆ†é’Ÿååˆ·æ–°ã€‚" >> Packages.stamp
          
          echo "ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡ï¼š"
          ls -lh Packages*
        else
          echo "âŒ Packages æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºå‹ç¼©ç‰ˆæœ¬"
          touch Packages.bz2 Packages.gz Packages.stamp
        fi
    
    # ç¬¬å…­æ­¥ï¼šæäº¤æ›´æ”¹
    - name: ğŸ’¾ Commit and push changes
      run: |
        echo "=== æäº¤æ›´æ”¹ ==="
        
        # é…ç½® git
        git config --local user.email "believess-bot@users.noreply.github.com"
        git config --local user.name "believess-bot"
        
        # æ·»åŠ æ–‡ä»¶
        git add Packages Packages.bz2 Packages.gz Packages.stamp
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --staged --quiet; then
          echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          # æäº¤å¹¶æ¨é€
          git commit -m "ğŸ¤– Auto-update: $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo "ğŸ”„ æ­£åœ¨æ¨é€æ›´æ”¹..."
          git push
          echo "âœ… æ›´æ”¹å·²æ¨é€åˆ°ä»“åº“"
          
          echo "ğŸ“ å·²æ·»åŠ çš„æ–‡ä»¶ï¼š"
          git show --stat --name-only HEAD | grep -E "(Packages|stamp)"
        fi
        
        echo "=== å®Œæˆ ==="
